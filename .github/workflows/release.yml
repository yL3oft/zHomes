name: Release Version

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compile and Test with Maven
        run: mvn clean install -DskipTests=false -Dgpg.skip=true

      - name: Get project version
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get final JAR name
        id: get_jar
        run: |
          JAR_FILE=$(mvn help:evaluate -Dexpression=project.build.finalName -q -DforceStdout).jar
          echo "jar=$JAR_FILE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: zHomes ${{ steps.get_version.outputs.version }}
          body_path: changelog.md
          files: target/${{ steps.get_jar.outputs.jar }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Modrinth (using curl)
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          curl -X POST https://api.modrinth.com/v2/version \
            -H "Authorization: $MODRINTH_TOKEN" \
            -F "project_id=veAp6a0M" \
            -F "version_number=${{ steps.get_version.outputs.version }}" \
            -F "version_type=release" \
            -F "changelog=$(cat changelog.md)" \
            -F "file=@target/${{ steps.get_jar.outputs.jar }}" \
            -F "loaders[]=folia" \
            -F "loaders[]=paper" \
            -F "loaders[]=purpur" \
            -F "loaders[]=spigot" \
            -F "game_versions[]=1.8" \
            -F "game_versions[]=1.8.1" \
            -F "game_versions[]=1.8.2" \
            -F "game_versions[]=1.8.3" \
            -F "game_versions[]=1.8.4" \
            -F "game_versions[]=1.8.5" \
            -F "game_versions[]=1.8.6" \
            -F "game_versions[]=1.8.7" \
            -F "game_versions[]=1.8.8" \
            -F "game_versions[]=1.9" \
            -F "game_versions[]=1.9.1" \
            -F "game_versions[]=1.9.2" \
            -F "game_versions[]=1.10" \
            -F "game_versions[]=1.10.1" \
            -F "game_versions[]=1.10.2" \
            -F "game_versions[]=1.11" \
            -F "game_versions[]=1.11.1" \
            -F "game_versions[]=1.11.2" \
            -F "game_versions[]=1.12" \
            -F "game_versions[]=1.12.1" \
            -F "game_versions[]=1.12.2" \
            -F "game_versions[]=1.13" \
            -F "game_versions[]=1.13.1" \
            -F "game_versions[]=1.13.2" \
            -F "game_versions[]=1.14" \
            -F "game_versions[]=1.14.1" \
            -F "game_versions[]=1.14.2" \
            -F "game_versions[]=1.14.3" \
            -F "game_versions[]=1.14.4" \
            -F "game_versions[]=1.15" \
            -F "game_versions[]=1.15.1" \
            -F "game_versions[]=1.15.2" \
            -F "game_versions[]=1.16" \
            -F "game_versions[]=1.16.1" \
            -F "game_versions[]=1.16.2" \
            -F "game_versions[]=1.16.3" \
            -F "game_versions[]=1.16.4" \
            -F "game_versions[]=1.16.5" \
            -F "game_versions[]=1.17" \
            -F "game_versions[]=1.17.1" \
            -F "game_versions[]=1.18" \
            -F "game_versions[]=1.18.1" \
            -F "game_versions[]=1.18.2" \
            -F "game_versions[]=1.19" \
            -F "game_versions[]=1.19.1" \
            -F "game_versions[]=1.19.2" \
            -F "game_versions[]=1.19.3" \
            -F "game_versions[]=1.19.4" \
            -F "game_versions[]=1.20" \
            -F "game_versions[]=1.20.1" \
            -F "game_versions[]=1.20.2" \
            -F "game_versions[]=1.21" \
            -F "game_versions[]=1.21.1" \
            -F "game_versions[]=1.21.2" \
            -F "game_versions[]=1.21.3" \
            -F "game_versions[]=1.21.4" \
            -F "game_versions[]=1.21.5" \
            -F "game_versions[]=1.21.6" \
            -F "game_versions[]=1.21.7" \
            -F "game_versions[]=1.21.8"